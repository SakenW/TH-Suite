# 《Minecraft 组合包与模组本地化扫描与回写系统 白皮书 v3.4 完整版》

> 更新日期：2025年1月  
> 最新特性：Minecraft 主题 UI 重构完成

---

## 🎮 最新更新

### v3.5 - 完整功能实现 (2025.01.02)
- **全功能页面**：所有占位页面升级为完整实现
- **安全管理系统**：用户权限控制（RBAC）、API密钥管理、数据加密、审计日志
- **服务器集成**：Trans-Hub 连接管理、实时同步、性能监控、离线模式
- **数据管理**：本地存储管理、缓存优化、自动备份、云同步
- **构建系统**：本地化包构建、多格式输出、任务队列、版本控制
- **传输管理**：批量上传下载、增量同步、冲突解决、断点续传

### v3.4 - Minecraft 主题 UI (2025.01.01)
- **全新界面设计**：完整的 Minecraft 视觉风格重构
- **游戏化组件库**：MinecraftButton、MinecraftCard、MinecraftProgress、MinecraftLoader、MinecraftBlock
- **沉浸式体验**：粒子效果、方块动画、游戏化过渡、附魔闪光
- **错误处理**：MinecraftErrorBoundary 游戏风格错误界面
- **响应式设计**：完美适配各种屏幕尺寸

---

## 一、前言

Minecraft 的模组（MOD）与组合包（Modpack）社区规模庞大，但本地化流程长期存在以下痛点：

1. **碎片化**：语言文件散落在成千上万的 JAR、组合包目录、任务脚本、资源包中。
2. **重复与冗余**：不同 MOD、不同版本重复出现相同的翻译键值。
3. **缺乏统一处理**：翻译结果难以安全、规范地写回原始容器，尤其是新增语言文件场景。
4. **质量不可控**：缺乏占位符校验、格式验证，导致游戏崩溃或 UI 错乱。
5. **追溯困难**：无法明确记录翻译的来源、变更、应用与回滚。

本白皮书提出一套 **扫描 → 上传服务器 → 统一处理 → 下载补丁 → 本地回写 → 验收与回滚** 的闭环架构，覆盖 **单独 MOD JAR** 与 **组合包目录（及其内部任务/脚本模块）**，形成一个可扩展、可追责、合规的多语言本地化基础设施。

---

## 二、系统目标

* **高效扫描与去重**：支持组合包/单独 MOD 两类入口，基于内容哈希去重。
* **统一翻译处理**：上传服务器 → 翻译记忆库/术语库/人工审校 → 生成补丁集。
* **安全回写**：Overlay 优先，JAR 修改可选，均支持回滚。
* **支持新增**：对本地不存在的语言文件，提供安全新建与规范化序列化。
* **质量控制**：占位符、格式、颜色码等门禁。
* **全链路追责**：从扫描到回写，所有对象和动作可溯源。
* **灵活扩展**：未来支持 DataPack、ScriptPack 等新容器。

---

## 三、整体闭环流程

1. **扫描**

   * Artifact（MOD JAR / Modpack 目录）扫描
   * 解析 Container（MOD / PackModule / Overlay）
   * 提取语言文件 → 转换为 Blobs 与 Entries
   * 计算内容哈希，写入数据库

2. **上传服务器**

   * 上传去重后的 Blobs 与键值对
   * 服务器端翻译处理 → 聚合结果

3. **生成补丁集 PatchSet**

   * 补丁项包含：目标 container、命名空间、locale、策略（overlay/replace/create\_if\_missing）、序列化配置、预期哈希

4. **下载并执行回写**

   * 转换为 Writeback Plan
   * Overlay 优先写入资源包；必要时修改 JAR / 任务包文件
   * 新文件场景：根据标准路径自动创建

5. **验收与入库**

   * 写入后规范化内容 → 计算 after\_hash，与 expected\_hash 对比
   * 入库 Occurrence 与 Entries
   * ApplyResult 记录完整状态（成功/失败/冲突/回滚）

6. **观测与报表**

   * 输出 `apply_report.json`
   * 指标监控（覆盖率、冲突率、回滚率、P95 时延）

---

## 四、数据模型设计

### 4.1 Artifact 与 Container

* **Artifact**：物理载体（JAR 文件、目录、资源包、数据包）
* **Container**：逻辑翻译单元（MOD、组合包模块、Overlay）

关系：**Artifact ⟶ Container ⟶ LanguageFile ⟶ Entries**

### 4.2 数据库表

#### artifacts

* `artifact_id` (PK)
* `artifact_type`: `mod_jar` | `modpack_dir` | `resource_pack` | `data_pack`
* `path`, `content_hash`, `size`, `first_seen`, `last_seen`

#### containers

* `container_id` (PK)
* `artifact_id` (FK)
* `container_type`: `mod` | `pack_module` | `overlay`
* `mod_id`, `display_name`, `version`, `loader_type`, `namespace`

#### language\_files

* `file_id` (PK)
* `container_id` (FK)
* `locale`, `namespace`, `file_path`
* `content_hash` (FK → blobs)
* `key_count`, `first_seen`, `last_seen`

#### blobs

* `blob_hash` (PK)
* `canonical_json`
* `size`, `entry_count`

#### entries\_current / entries\_versions

* `entry_key` = `blob_hash#translation_key`
* `translation_key`, `value`, `first_seen`, `last_seen`
* 历史版本支持 `from_scan_id`/`until_scan_id`

#### serialization\_profiles

* `profile_id`
* `format` (`json`/`lang`/`properties`)
* `charset`, `newline`, `bom`, `escape_style`, `sort_policy`

#### patch\_sets / patch\_items

* `patch_set_id`, `patch_item_id`
* `target_container_id`
* `namespace`, `locale`, `policy`, `expected_blob_hash`
* `serializer_profile_id`
* `upstream_anchor_blob`
* `signature`, `version`

#### writeback\_plans / apply\_runs / apply\_results

* Plan：由 PatchSet 转换
* Run：一次执行
* Result：哈希比对、冲突情况、回滚状态

#### quality\_checks

* `entry_key`
* 占位符、格式、颜色码、长度等校验结果

#### locale\_aliases / fallback\_rules

* 规范化映射（BCP-47 ↔ MC `zh_cn` 格式）
* 回落链（如 zh\_cn → zh → en\_us）

---

## 五、Patch & Plan 协议规范

### PatchItem

* `target_container_id`
* `namespace`, `locale`
* `policy`: overlay | replace | merge | create\_if\_missing
* `expected_blob_hash`, `expected_entry_count`
* `serializer_profile_id` 或内联配置
* `target_member_path`（可选）
* `upstream_anchor_blob`（可选）
* `signature`, `version`

### Writeback Plan

* 按 PatchItem 转换而来
* 明确执行动作：写入路径、策略、校验条件

---

## 六、回写策略

### 6.1 Overlay（默认）

* 输出到 `resourcepacks/<project>/assets/{namespace}/lang/{locale}.json`
* 自动生成 `pack.mcmeta`（含 `pack_format` 与描述）
* 可一键切换/回滚

### 6.2 JAR 就地

* 适用于必须嵌入分发包的情况
* 步骤：

  1. 快照备份 JAR
  2. 修改/新建成员
  3. 校验 after\_hash == expected\_hash
  4. 失败 → 还原备份

### 6.3 任务包/数据包

* Container.type=pack\_module
* 直接写入 JSON/NBT 配置文件，策略同 Overlay

---

## 七、质量门禁（QualityGate）

* **占位符一致性**：翻译前后占位符集合相同
* **格式校验**：JSON 可解析，Properties 转义合法
* **颜色码校验**：`§` 码数量相同
* **长度比校验**：过长/过短警告
* **禁止空值覆盖**：非空值禁止被空串替换
* **三方合并**：冲突落 `.rej`，不自动覆盖

---

## 八、安全与合规

* **签名验证**：PatchSet 必须含签名与摘要
* **许可证遵循**：Overlay 默认安全，JAR 修改需人工审批
* **RBAC**：作者 → 审校 → 发布 → 执行，支持双审
* **幂等与防重**：PatchItem ID + expected\_hash 唯一，避免重复执行

---

## 九、可观测与审计

* **TraceID**：贯穿扫描、上传、回写全链路
* **指标监控**：

  * 去重率
  * 翻译覆盖率
  * 冲突率
  * 回滚率
  * P95 时延
* **报表**：每次 ApplyRun 输出 JSON 报告
* **备份策略**：Overlay 多版本，JAR 最近 N 次快照

---

## 十、风险与对策

* **翻译错误崩溃**

  * 对策：占位符门禁、二次校验
* **MOD 更新冲突**

  * 对策：三方合并，冲突拒绝写入
* **许可证违规**

  * 对策：优先 Overlay，JAR 修改需人工确认
* **性能瓶颈**

  * 对策：流式扫描、分片上传、外置存储

---

## 十一、落地实施步骤

1. 落地数据库 schema（Postgres/SQLite）
2. 开发扫描器（支持 modpack\_dir / mod\_jar）
3. 实现上传协议（NDJSON 流式）
4. 定义补丁 manifest JSON Schema
5. 编写 Writeback 执行器（Overlay → JAR → 校验 → 回滚）
6. 接入质量门禁（占位符、格式、长度）
7. 部署观测系统（apply\_report.json + Grafana）
8. 实现回滚工具（删除 Overlay / 恢复 JAR 备份）

---

## 十二、未来展望

* **翻译协作平台**：Web 界面众包、术语库管理
* **自动化测试**：结合启动器 API，自动验证翻译加载情况
* **多语言标准化**：支持 BCP-47 locale 全集与 fallback 机制
* **插件化生态**：FTB Quests/KubeJS 专属解析器插件
* **可信存证**：关键 PatchSet 上链，保证可追责

---

## 结语

本系统实现了从 **扫描识别 → 去重聚合 → 翻译处理 → 安全回写 → 验收回滚 → 全链路追责** 的完整闭环。
通过 **Artifact/Container 的双层建模**，既能处理单独 MOD，也能处理整个组合包及其内部模块。
这是 Minecraft 多语言本地化的一套**可扩展、可持续、可合规**的基础设施。
